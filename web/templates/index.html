<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirGlow Status Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="banner-container">
        <img src="https://raw.githubusercontent.com/RoyalPineapple/airglow/master/web/static/banner.jpg" alt="Aurora Borealis" class="banner-image" onerror="this.parentElement.style.display='none'">
        <div class="banner-overlay">
            <h1 class="banner-title">AirGlow Status Dashboard</h1>
        </div>
    </div>
    <div class="container">
        <header>
            <nav>
                <a href="/">Home</a>
                <a href="/config">Configuration</a>
                <a href="http://{{ request.host.split(':')[0] }}:8888" target="_blank">LedFX Web Interface</a>
            </nav>
        </header>

        <div class="status-header">
            <button id="refresh-btn" class="btn btn-primary" title="Refresh status">
                <span id="refresh-icon">ðŸ”„</span> Refresh
            </button>
            <div id="last-update" class="last-update"></div>
        </div>

        <div id="status-container">
            <p class="loading">Loading status...</p>
        </div>
    </div>

    <script>
        let refreshInterval = null;

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatStatus(status) {
            return status ? '<span class="status-dot status-ok"></span> Yes' : '<span class="status-dot status-error"></span> No';
        }

        function formatVersion(version) {
            return version ? ` (v${escapeHtml(version)})` : '';
        }

        async function refreshStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                const container = document.getElementById('status-container');
                let html = '';

                // Container Status
                html += '<section class="status-section">';
                html += '<h2>Container Status</h2>';
                html += '<div class="status-grid">';
                html += `<div class="status-item"><span class="status-label">LedFX:</span> ${formatStatus(data.containers.ledfx.running)}${formatVersion(data.containers.ledfx.version)}</div>`;
                html += `<div class="status-item"><span class="status-label">Shairport-Sync:</span> ${formatStatus(data.containers.shairport_sync.running)}${formatVersion(data.containers.shairport_sync.version)}</div>`;
                html += '</div>';
                html += '</section>';

                // Audio System
                html += '<section class="status-section">';
                html += '<h2>Audio System</h2>';
                html += '<div class="status-grid">';
                const audio = data.audio || {};
                html += `<div class="status-item"><span class="status-label">PulseAudio:</span> ${formatStatus(audio.pulseaudio?.available)}</div>`;
                html += `<div class="status-item"><span class="status-label">Active Streams:</span> <span class="status-value">${audio.active_streams || 0}</span></div>`;
                if (data.ledfx_audio_device?.configured_device) {
                    const deviceName = data.ledfx_audio_device.configured_device.replace(/^ALSA: /, '');
                    html += `<div class="status-item"><span class="status-label">Audio Input:</span> <span class="status-value">${escapeHtml(deviceName)}</span></div>`;
                }
                html += '</div>';
                html += '</section>';

                // Playback Status
                html += '<section class="status-section">';
                html += '<h2>Playback Status</h2>';
                html += '<div class="status-grid">';
                const shairportPlaying = audio.shairport_connected && !audio.shairport_corked;
                html += `<div class="status-item"><span class="status-label">AirPlay Active:</span> ${formatStatus(shairportPlaying)}${shairportPlaying ? '' : ' <span class="status-hint">(no active connection)</span>'}</div>`;
                html += `<div class="status-item"><span class="status-label">LedFX Processing:</span> ${formatStatus(audio.ledfx_streaming_flag)}${audio.ledfx_streaming_flag ? '' : ' <span class="status-hint">(idle - no audio input)</span>'}</div>`;
                html += '</div>';
                html += '</section>';

                // Diagnostics
                html += '<section class="status-section">';
                html += '<h2>Diagnostics</h2>';
                html += '<p class="section-description">Run a comprehensive system check to diagnose issues</p>';
                html += '<button id="run-diagnostic" class="btn btn-primary">Run Diagnostic Check</button>';
                html += '<div id="diagnostic-output" class="diagnostic-output" style="display: none;"></div>';
                html += '</section>';

                container.innerHTML = html;

                // Attach diagnostic button handler
                const diagnosticBtn = document.getElementById('run-diagnostic');
                if (diagnosticBtn) {
                    diagnosticBtn.addEventListener('click', runDiagnostic);
                }

                // Update last update time
                document.getElementById('last-update').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;

            } catch (error) {
                console.error('Error fetching status:', error);
                document.getElementById('status-container').innerHTML = `<p class="error">Error loading status: ${escapeHtml(error.message)}</p>`;
                document.getElementById('last-update').textContent = 'Error loading status';
            }
        }

        async function runDiagnostic() {
            const btn = document.getElementById('run-diagnostic');
            const output = document.getElementById('diagnostic-output');
            
            btn.disabled = true;
            btn.textContent = 'Running...';
            output.style.display = 'block';
            output.innerHTML = '<pre>Running diagnostic check...</pre>';

            try {
                const response = await fetch('/api/diagnose', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.error) {
                    output.innerHTML = `<pre class="error">Error: ${escapeHtml(data.error)}</pre>`;
                } else {
                    output.innerHTML = `<pre>${escapeHtml(data.output || '')}</pre>`;
                }
            } catch (error) {
                output.innerHTML = `<pre class="error">Error: ${escapeHtml(error.message)}</pre>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Run Diagnostic Check';
            }
        }

        // Initial load
        refreshStatus();

        // Add refresh button handler
        const refreshBtn = document.getElementById('refresh-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                refreshStatus();
                // Add visual feedback
                const icon = document.getElementById('refresh-icon');
                if (icon) {
                    icon.style.animation = 'spin 0.5s linear';
                    setTimeout(() => {
                        icon.style.animation = '';
                    }, 500);
                }
            });
        }

        // Auto-refresh every 5 seconds
        refreshInterval = setInterval(refreshStatus, 5000);

        // Clear interval on page unload
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>
