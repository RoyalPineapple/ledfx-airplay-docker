<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirGlow Status Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="banner-container">
        <img src="https://raw.githubusercontent.com/RoyalPineapple/airglow/master/web/static/banner.jpg" alt="Aurora Borealis" class="banner-image" onerror="this.parentElement.style.display='none'">
        <div class="banner-overlay">
            <h1 class="banner-title">AirGlow Status Dashboard</h1>
        </div>
    </div>
    <div class="container">
        <header>
            <nav>
                <a href="/">Home</a>
                <a href="/config">Configuration</a>
                <a href="/browser">AirPlay Browser</a>
                <a href="/ledfx">LedFX</a>
            </nav>
        </header>

        <div class="status-header">
            <button id="refresh-btn" class="btn btn-primary" title="Refresh status">
                <span id="refresh-icon">ðŸ”„</span> Refresh
            </button>
            <div id="last-update" class="last-update"></div>
        </div>

        <div id="status-container">
            <p class="loading">Loading status...</p>
        </div>
    </div>

    <script>
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatStatus(status, labelTrue = 'Active', labelFalse = 'Inactive') {
            if (status) {
                return '<span class="status-dot status-ok"></span> ' + escapeHtml(labelTrue);
            } else {
                return '<span class="status-dot status-error"></span> ' + escapeHtml(labelFalse);
            }
        }

        function formatStatusNeutral(status, labelTrue = 'Active', labelFalse = 'Inactive') {
            if (status) {
                return '<span class="status-dot status-ok"></span> ' + escapeHtml(labelTrue);
            } else {
                return '<span class="status-dot status-neutral"></span> ' + escapeHtml(labelFalse);
            }
        }

        function formatStatusWithWarning(status, warning, labelTrue = 'Active', labelFalse = 'Inactive', labelWarning = 'Warning') {
            if (warning) {
                return '<span class="status-dot status-warning"></span> ' + escapeHtml(labelWarning);
            } else if (status) {
                return '<span class="status-dot status-ok"></span> ' + escapeHtml(labelTrue);
            } else {
                return '<span class="status-dot status-error"></span> ' + escapeHtml(labelFalse);
            }
        }

        function formatVersion(version) {
            return version ? ` (v${escapeHtml(version)})` : '';
        }

        async function refreshStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                const container = document.getElementById('status-container');
                let html = '';

                // Calculate overall system health
                const containers = data.containers || {};
                // Define display names for known containers
                const containerNames = {
                    'avahi': 'Avahi',
                    'nqptp': 'NQPTP',
                    'ledfx': 'LedFX',
                    'shairport_sync': 'Shairport-Sync'
                };
                // Define preferred order for known containers (others will appear after)
                const preferredOrder = ['avahi', 'ledfx', 'shairport_sync'];
                // Build ordered list: preferred containers first, then any others
                const containerOrder = [];
                const seen = new Set();
                // Add preferred containers that exist in data
                for (const key of preferredOrder) {
                    if (containers[key]) {
                        containerOrder.push(key);
                        seen.add(key);
                    }
                }
                // Add any other containers that weren't in preferred order
                for (const key of Object.keys(containers)) {
                    if (!seen.has(key)) {
                        containerOrder.push(key);
                    }
                }
                
                let runningCount = 0;
                let totalCount = 0;
                for (const [key, container] of Object.entries(containers)) {
                    totalCount++;
                    if (container.running) runningCount++;
                }
                
                const containersRunning = runningCount === totalCount;
                const audioSystemOk = data.audio?.pulseaudio?.available;
                const shairportPlaying = data.audio?.shairport_connected && !data.audio?.shairport_corked;
                const ledfxProcessing = data.audio?.ledfx_streaming_flag;
                
                // Check diagnostic warnings and errors
                const diagnosticWarnings = data.diagnostics?.warnings || 0;
                const diagnosticErrors = data.diagnostics?.errors || 0;
                
                let issues = 0;
                if (!containersRunning) issues++;
                if (!audioSystemOk) issues++;
                if (diagnosticErrors > 0) issues += diagnosticErrors;
                // Count warnings as partial issues (2 warnings = 1 issue)
                if (diagnosticWarnings > 0) {
                    issues += Math.ceil(diagnosticWarnings / 2);
                }
                if (!shairportPlaying && !ledfxProcessing) {
                    // Only count as issue if both are inactive (normal idle state)
                }
                
                const overallStatus = issues === 0 ? 'ok' : (issues <= 1 ? 'warning' : 'error');
                let statusMessage = 'All Systems Operational';
                if (issues > 0) {
                    if (diagnosticErrors > 0) {
                        statusMessage = `${diagnosticErrors} Error${diagnosticErrors > 1 ? 's' : ''} Detected`;
                    } else if (diagnosticWarnings > 0) {
                        statusMessage = `${diagnosticWarnings} Warning${diagnosticWarnings > 1 ? 's' : ''} Detected`;
                    } else {
                        statusMessage = issues === 1 ? '1 Issue Detected' : `${issues} Issues Detected`;
                    }
                }
                
                // Summary Card
                html += '<section class="status-summary status-summary-' + overallStatus + '">';
                html += '<div class="summary-content">';
                html += '<h2 class="summary-title">' + escapeHtml(statusMessage) + '</h2>';
                html += '<div class="summary-stats">';
                html += '<div class="summary-stat">';
                html += '<span class="summary-label">Containers:</span> ';
                html += containersRunning ? `<span class="summary-value success">${runningCount}/${totalCount} Running</span>` : `<span class="summary-value error">${runningCount}/${totalCount} Running</span>`;
                html += '</div>';
                html += '<div class="summary-stat">';
                html += '<span class="summary-label">Audio System:</span> ';
                html += audioSystemOk ? '<span class="summary-value success">Connected</span>' : '<span class="summary-value error">Disconnected</span>';
                html += '</div>';
                html += '<div class="summary-stat">';
                html += '<span class="summary-label">Playback:</span> ';
                if (shairportPlaying || ledfxProcessing) {
                    html += '<span class="summary-value success">Active</span>';
                } else {
                    html += '<span class="summary-value">Idle</span>';
                }
                html += '</div>';
                html += '</div>';
                html += '</div>';
                
                // Show diagnostic warnings and errors if present
                if (diagnosticWarnings > 0 || diagnosticErrors > 0) {
                    // Use error styling if there are errors, warning styling if only warnings
                    const alertBgColor = diagnosticErrors > 0 ? 'rgba(231, 76, 60, 0.1)' : 'rgba(243, 156, 18, 0.1)';
                    const alertBorderColor = diagnosticErrors > 0 ? 'var(--color-error)' : 'var(--color-warning)';
                    html += `<div class="diagnostic-alerts" style="margin-top: 1rem; padding: 0.75rem; background: ${alertBgColor}; border-left: 3px solid ${alertBorderColor}; border-radius: 4px;">`;
                    
                    if (diagnosticErrors > 0) {
                        html += `<div style="color: var(--color-error); font-weight: 600; margin-bottom: 0.5rem;">${diagnosticErrors} Diagnostic Error${diagnosticErrors > 1 ? 's' : ''}</div>`;
                        if (data.diagnostics?.error_messages && data.diagnostics.error_messages.length > 0) {
                            html += '<ul style="margin: 0.5rem 0 0 1.5rem; padding: 0; color: var(--color-error); font-size: 0.9rem;">';
                            data.diagnostics.error_messages.forEach(msg => {
                                html += `<li>${escapeHtml(msg)}</li>`;
                            });
                            html += '</ul>';
                        }
                    }
                    
                    if (diagnosticWarnings > 0) {
                        html += `<div style="color: var(--color-warning); font-weight: 600; margin-bottom: 0.5rem; margin-top: ${diagnosticErrors > 0 ? '0.75rem' : '0'};">${diagnosticWarnings} Diagnostic Warning${diagnosticWarnings > 1 ? 's' : ''}</div>`;
                        if (data.diagnostics?.warning_messages && data.diagnostics.warning_messages.length > 0) {
                            html += '<ul style="margin: 0.5rem 0 0 1.5rem; padding: 0; color: var(--color-text-light); font-size: 0.9rem;">';
                            data.diagnostics.warning_messages.forEach(msg => {
                                html += `<li>${escapeHtml(msg)}</li>`;
                            });
                            html += '</ul>';
                        }
                    }
                    
                    html += '<div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--color-text-light);">Run diagnostic check below for details</div>';
                    html += '</div>';
                }
                
                html += '</section>';

                // Container Status - Display as cards
                html += '<section class="status-section">';
                html += '<h2>Container Status</h2>';
                html += '<div class="container-cards-grid">';
                
                // Display all containers as cards, ordered by dependency
                for (const key of containerOrder) {
                    if (!containers[key]) continue; // Skip if container not in data
                    
                    const container = containers[key];
                    const displayName = containerNames[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    // Use container_name from API if available, otherwise derive from key
                    const containerName = container.container_name || 
                                         (key === 'shairport_sync' ? 'shairport-sync' : 
                                          key === 'airglow_web' ? 'airglow-web' : 
                                          key.replace(/_/g, '-'));
                    const statusHtml = formatStatus(container.running, 'Running', 'Stopped');
                    const versionHtml = formatVersion(container.version);
                    const restartBtnId = `restart-${key}`;
                    
                    html += `<div class="container-card">`;
                    html += `<div class="container-card-header">`;
                    html += `<h3 class="container-card-title">${escapeHtml(displayName)}</h3>`;
                    html += `${statusHtml}`;
                    html += `</div>`;
                    html += `<div class="container-card-body">`;
                    if (container.version) {
                        html += `<div class="container-card-version">Version: ${escapeHtml(container.version)}</div>`;
                    } else {
                        html += `<div class="container-card-version">Version: N/A</div>`;
                    }
                    html += `</div>`;
                    html += `<div class="container-card-footer">`;
                    html += `<button id="${restartBtnId}" class="btn btn-sm btn-outline" data-container="${containerName}">Restart</button>`;
                    html += `</div>`;
                    html += `</div>`;
                }
                
                html += '</div>';
                html += '</section>';

                // Audio System
                html += '<section class="status-section">';
                html += '<h2>Audio System</h2>';
                html += '<div class="status-grid">';
                const audio = data.audio || {};
                const pulseaudio = audio.pulseaudio || {};
                html += `<div class="status-item"><span class="status-label">PulseAudio:</span> ${formatStatus(pulseaudio.available, 'Connected', 'Disconnected')}</div>`;
                html += `<div class="status-item"><span class="status-label">Active Streams:</span> <span class="status-value">${audio.active_streams || 0}</span></div>`;
                if (data.ledfx_audio_device?.configured_device) {
                    const deviceName = data.ledfx_audio_device.configured_device.replace(/^ALSA: /, '');
                    const isPulse = deviceName.toLowerCase() === 'pulse';
                    html += `<div class="status-item"><span class="status-label">LedFX Audio Input:</span> ${formatStatus(isPulse, 'Pulse', escapeHtml(deviceName))}</div>`;
                }
                html += '</div>';
                html += '</section>';

                // AirPlay Status
                html += '<section class="status-section">';
                html += '<h2>AirPlay Status</h2>';
                html += '<div class="status-grid">';
                const airplay = data.airplay || {};
                if (airplay.device_name) {
                    html += `<div class="status-item"><span class="status-label">Device Name:</span> <span class="status-value">${escapeHtml(airplay.device_name)}</span></div>`;
                }
                html += `<div class="status-item"><span class="status-label">Service Running:</span> ${formatStatus(airplay.running, 'Running', 'Stopped')}</div>`;
                html += `<div class="status-item"><span class="status-label">Avahi Running:</span> ${formatStatus(airplay.avahi_running, 'Running', 'Stopped')}</div>`;
                html += `<div class="status-item"><span class="status-label">D-Bus Connected:</span> ${formatStatus(airplay.d_bus_connected, 'Connected', 'Disconnected')}${!airplay.d_bus_connected && airplay.running && airplay.avahi_running ? ' <span class="status-hint">(shairport-sync cannot reach Avahi)</span>' : ''}</div>`;
                html += `<div class="status-item"><span class="status-label">Advertising on Network:</span> ${formatStatus(airplay.advertising, 'Yes', 'No')}${!airplay.advertising && airplay.running && airplay.avahi_running ? ' <span class="status-hint">(device not found in network)</span>' : ''}</div>`;
                if (airplay.error) {
                    html += `<div class="status-item"><span class="status-label">Status:</span> <span class="status-value" style="color: var(--color-warning);">${escapeHtml(airplay.error)}</span></div>`;
                }
                html += '</div>';
                html += '</section>';

                // Playback Status
                html += '<section class="status-section">';
                html += '<h2>Playback Status</h2>';
                html += '<div class="status-grid">';
                // shairportPlaying already declared above for summary calculation
                html += `<div class="status-item"><span class="status-label">AirPlay Active:</span> ${formatStatusNeutral(shairportPlaying, 'Active', 'Inactive')}${shairportPlaying ? '' : ' <span class="status-hint">(no active connection)</span>'}</div>`;
                html += `<div class="status-item"><span class="status-label">LedFX Processing:</span> ${formatStatusNeutral(audio.ledfx_streaming_flag, 'Active', 'Inactive')}${audio.ledfx_streaming_flag ? '' : ' <span class="status-hint">(idle - no audio input)</span>'}</div>`;
                html += '</div>';
                html += '</section>';

                // Diagnostics
                html += '<section class="status-section">';
                html += '<h2>Diagnostics</h2>';
                html += '<p class="section-description">Run a comprehensive system check to diagnose issues</p>';
                html += '<button id="run-diagnostic" class="btn btn-primary">Run Diagnostic Check</button>';
                html += '<div id="diagnostic-output" class="diagnostic-output" style="display: none;"></div>';
                html += '</section>';

                container.innerHTML = html;

                // Attach diagnostic button handler
                const diagnosticBtn = document.getElementById('run-diagnostic');
                if (diagnosticBtn) {
                    diagnosticBtn.addEventListener('click', runDiagnostic);
                }
                
                // Attach restart button handlers for all containers (in dependency order)
                for (const key of containerOrder) {
                    if (!containers[key]) continue;
                    const restartBtnId = `restart-${key}`;
                    const restartBtn = document.getElementById(restartBtnId);
                    if (restartBtn) {
                        restartBtn.addEventListener('click', () => {
                            const containerName = restartBtn.getAttribute('data-container');
                            restartContainer(containerName, restartBtn);
                        });
                    }
                }

                // Update last update time (simplified format)
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                document.getElementById('last-update').textContent = timeStr;

            } catch (error) {
                console.error('Error fetching status:', error);
                document.getElementById('status-container').innerHTML = `<p class="error">Error loading status: ${escapeHtml(error.message)}</p>`;
                document.getElementById('last-update').textContent = 'Error loading status';
            }
        }

        async function runDiagnostic() {
            const btn = document.getElementById('run-diagnostic');
            const output = document.getElementById('diagnostic-output');
            
            btn.disabled = true;
            btn.textContent = 'Running...';
            output.style.display = 'block';
            output.innerHTML = '<pre>Running diagnostic check...</pre>';

            try {
                const response = await fetch('/api/diagnose', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.error) {
                    output.innerHTML = `<pre class="error">Error: ${escapeHtml(data.error)}</pre>`;
                } else {
                    output.innerHTML = `<pre>${escapeHtml(data.output || '')}</pre>`;
                }
            } catch (error) {
                output.innerHTML = `<pre class="error">Error: ${escapeHtml(error.message)}</pre>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Run Diagnostic Check';
            }
        }

        // Initial load
        refreshStatus();

        // Add refresh button handler
        const refreshBtn = document.getElementById('refresh-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                refreshStatus();
                // Add visual feedback
                const icon = document.getElementById('refresh-icon');
                if (icon) {
                    icon.style.animation = 'spin 0.5s linear';
                    setTimeout(() => {
                        icon.style.animation = '';
                    }, 500);
                }
            });
        }
    </script>
</body>
</html>
