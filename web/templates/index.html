<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirGlow Status Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="banner-container">
        <img src="https://raw.githubusercontent.com/RoyalPineapple/airglow/master/web/static/banner.jpg" alt="Aurora Borealis" class="banner-image" onerror="this.parentElement.style.display='none'">
        <div class="banner-overlay">
            <h1 class="banner-title">AirGlow Status Dashboard</h1>
        </div>
    </div>
    <div class="container">
        <header>
            <nav>
                <a href="/">Home</a>
                <a href="/config">Configuration</a>
                <a href="http://{{ request.host.split(':')[0] }}:8888" target="_blank">LedFX Web Interface</a>
            </nav>
        </header>

        <div class="status-header">
            <button id="refresh-btn" class="btn btn-primary" title="Refresh status">
                <span id="refresh-icon">ðŸ”„</span> Refresh
            </button>
            <div id="last-update" class="last-update"></div>
        </div>

        <div id="status-container">
            <p class="loading">Loading status...</p>
        </div>
    </div>

    <script>
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatStatus(status, labelTrue = 'Active', labelFalse = 'Inactive') {
            if (status) {
                return '<span class="status-dot status-ok"></span> ' + escapeHtml(labelTrue);
            } else {
                return '<span class="status-dot status-error"></span> ' + escapeHtml(labelFalse);
            }
        }

        function formatStatusNeutral(status, labelTrue = 'Active', labelFalse = 'Inactive') {
            if (status) {
                return '<span class="status-dot status-ok"></span> ' + escapeHtml(labelTrue);
            } else {
                return '<span class="status-dot status-neutral"></span> ' + escapeHtml(labelFalse);
            }
        }

        function formatStatusWithWarning(status, warning, labelTrue = 'Active', labelFalse = 'Inactive', labelWarning = 'Warning') {
            if (warning) {
                return '<span class="status-dot status-warning"></span> ' + escapeHtml(labelWarning);
            } else if (status) {
                return '<span class="status-dot status-ok"></span> ' + escapeHtml(labelTrue);
            } else {
                return '<span class="status-dot status-error"></span> ' + escapeHtml(labelFalse);
            }
        }

        function formatVersion(version) {
            return version ? ` (v${escapeHtml(version)})` : '';
        }

        async function refreshStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                const container = document.getElementById('status-container');
                let html = '';

                // Calculate overall system health
                const containersRunning = data.containers.ledfx.running && data.containers.shairport_sync.running;
                const audioSystemOk = data.audio?.pulseaudio?.available;
                const shairportPlaying = data.audio?.shairport_connected && !data.audio?.shairport_corked;
                const ledfxProcessing = data.audio?.ledfx_streaming_flag;
                
                let issues = 0;
                if (!containersRunning) issues++;
                if (!audioSystemOk) issues++;
                if (!shairportPlaying && !ledfxProcessing) {
                    // Only count as issue if both are inactive (normal idle state)
                }
                
                const overallStatus = issues === 0 ? 'ok' : (issues <= 1 ? 'warning' : 'error');
                const statusMessage = issues === 0 ? 'All Systems Operational' : 
                                     (issues === 1 ? '1 Issue Detected' : `${issues} Issues Detected`);
                
                // Summary Card
                html += '<section class="status-summary status-summary-' + overallStatus + '">';
                html += '<div class="summary-content">';
                html += '<h2 class="summary-title">' + escapeHtml(statusMessage) + '</h2>';
                html += '<div class="summary-stats">';
                html += '<div class="summary-stat">';
                html += '<span class="summary-label">Containers:</span> ';
                html += containersRunning ? '<span class="summary-value success">2 Running</span>' : '<span class="summary-value error">Issues</span>';
                html += '</div>';
                html += '<div class="summary-stat">';
                html += '<span class="summary-label">Audio System:</span> ';
                html += audioSystemOk ? '<span class="summary-value success">Connected</span>' : '<span class="summary-value error">Disconnected</span>';
                html += '</div>';
                html += '<div class="summary-stat">';
                html += '<span class="summary-label">Playback:</span> ';
                if (shairportPlaying || ledfxProcessing) {
                    html += '<span class="summary-value success">Active</span>';
                } else {
                    html += '<span class="summary-value">Idle</span>';
                }
                html += '</div>';
                html += '</div>';
                html += '</div>';
                html += '</section>';

                // Container Status
                html += '<section class="status-section">';
                html += '<h2>Container Status</h2>';
                html += '<div class="status-grid">';
                html += `<div class="status-item"><span class="status-label">LedFX:</span> ${formatStatus(data.containers.ledfx.running, 'Running', 'Stopped')}${formatVersion(data.containers.ledfx.version)}</div>`;
                html += `<div class="status-item"><span class="status-label">Shairport-Sync:</span> ${formatStatus(data.containers.shairport_sync.running, 'Running', 'Stopped')}${formatVersion(data.containers.shairport_sync.version)}</div>`;
                html += '</div>';
                html += '</section>';

                // Audio System
                html += '<section class="status-section">';
                html += '<h2>Audio System</h2>';
                html += '<div class="status-grid">';
                const audio = data.audio || {};
                const pulseaudio = audio.pulseaudio || {};
                html += `<div class="status-item"><span class="status-label">PulseAudio:</span> ${formatStatus(pulseaudio.available, 'Connected', 'Disconnected')}</div>`;
                html += `<div class="status-item"><span class="status-label">Active Streams:</span> <span class="status-value">${audio.active_streams || 0}</span></div>`;
                if (data.ledfx_audio_device?.configured_device) {
                    const deviceName = data.ledfx_audio_device.configured_device.replace(/^ALSA: /, '');
                    html += `<div class="status-item"><span class="status-label">Audio Input:</span> <span class="status-value">${escapeHtml(deviceName)}</span></div>`;
                }
                html += '</div>';
                html += '</section>';

                // Playback Status
                html += '<section class="status-section">';
                html += '<h2>Playback Status</h2>';
                html += '<div class="status-grid">';
                // shairportPlaying already declared above for summary calculation
                html += `<div class="status-item"><span class="status-label">AirPlay Active:</span> ${formatStatusNeutral(shairportPlaying, 'Active', 'Inactive')}${shairportPlaying ? '' : ' <span class="status-hint">(no active connection)</span>'}</div>`;
                html += `<div class="status-item"><span class="status-label">LedFX Processing:</span> ${formatStatusNeutral(audio.ledfx_streaming_flag, 'Active', 'Inactive')}${audio.ledfx_streaming_flag ? '' : ' <span class="status-hint">(idle - no audio input)</span>'}</div>`;
                html += '</div>';
                html += '</section>';

                // Diagnostics
                html += '<section class="status-section">';
                html += '<h2>Diagnostics</h2>';
                html += '<p class="section-description">Run a comprehensive system check to diagnose issues</p>';
                html += '<button id="run-diagnostic" class="btn btn-primary">Run Diagnostic Check</button>';
                html += '<div id="diagnostic-output" class="diagnostic-output" style="display: none;"></div>';
                html += '</section>';

                container.innerHTML = html;

                // Attach diagnostic button handler
                const diagnosticBtn = document.getElementById('run-diagnostic');
                if (diagnosticBtn) {
                    diagnosticBtn.addEventListener('click', runDiagnostic);
                }

                // Update last update time (simplified format)
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                document.getElementById('last-update').textContent = timeStr;

            } catch (error) {
                console.error('Error fetching status:', error);
                document.getElementById('status-container').innerHTML = `<p class="error">Error loading status: ${escapeHtml(error.message)}</p>`;
                document.getElementById('last-update').textContent = 'Error loading status';
            }
        }

        async function runDiagnostic() {
            const btn = document.getElementById('run-diagnostic');
            const output = document.getElementById('diagnostic-output');
            
            btn.disabled = true;
            btn.textContent = 'Running...';
            output.style.display = 'block';
            output.innerHTML = '<pre>Running diagnostic check...</pre>';

            try {
                const response = await fetch('/api/diagnose', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.error) {
                    output.innerHTML = `<pre class="error">Error: ${escapeHtml(data.error)}</pre>`;
                } else {
                    output.innerHTML = `<pre>${escapeHtml(data.output || '')}</pre>`;
                }
            } catch (error) {
                output.innerHTML = `<pre class="error">Error: ${escapeHtml(error.message)}</pre>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Run Diagnostic Check';
            }
        }

        // Initial load
        refreshStatus();

        // Add refresh button handler
        const refreshBtn = document.getElementById('refresh-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                refreshStatus();
                // Add visual feedback
                const icon = document.getElementById('refresh-icon');
                if (icon) {
                    icon.style.animation = 'spin 0.5s linear';
                    setTimeout(() => {
                        icon.style.animation = '';
                    }, 500);
                }
            });
        }
    </script>
</body>
</html>
