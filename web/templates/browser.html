<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirGlow - AirPlay Browser</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="banner-container">
        <img src="https://raw.githubusercontent.com/RoyalPineapple/airglow/master/web/static/banner.jpg" alt="Aurora Borealis" class="banner-image" onerror="this.parentElement.style.display='none'">
        <div class="banner-overlay">
            <h1 class="banner-title">AirGlow</h1>
            <p class="banner-tagline">AirPlay Browser</p>
        </div>
    </div>
    <div class="container">
        <header>
            <nav>
                <a href="/ledfx">LedFX</a>
                <a href="/">Configuration</a>
                <a href="/status">Status Dashboard</a>
                <a href="/browser" class="active">AirPlay Browser</a>
            </nav>
        </header>

        <div class="status-header">
            <label class="checkbox-label" style="align-items: center; gap: 0.5rem;">
                <input type="checkbox" id="auto-refresh-toggle" class="checkbox-input" checked>
                <span class="checkbox-text">Auto-refresh</span>
            </label>
            <button type="button" id="refresh-btn" class="btn btn-primary" title="Refresh browser">
                <span id="refresh-icon">ðŸ”„</span> Refresh
            </button>
            <div id="last-update" class="last-update"></div>
        </div>

        <div id="error-message" class="message error-message" role="alert" style="display: none;">
            <span id="error-text"></span>
            <button type="button" class="message-close" data-target="error-message" aria-label="Dismiss error">&times;</button>
        </div>

        <!-- AirPlay Devices Section -->
        <section class="status-section">
            <h2>AirPlay Devices</h2>
            <p class="section-description">Discover AirPlay compatible devices on your network</p>
            <div id="devices-loading" class="loading" style="display: none;">Loading...</div>
            <div id="devices-error" class="error" style="display: none;"></div>
            <div id="devices-table" style="display: none;"></div>
            <div id="devices-empty" class="loading" style="display: none;">No AirPlay devices found on the network.</div>
        </section>
    </div>

    <script>
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        let autoRefreshInterval = null;
        const AUTO_REFRESH_INTERVAL = 20000; // 20 seconds

        function showError(message) {
            const errorEl = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            if (errorText) {
                errorText.textContent = message;
            } else {
                errorEl.textContent = message;
            }
            errorEl.style.display = 'flex';
        }

        function initMessageClosers() {
            document.querySelectorAll('.message-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.dataset.target;
                    const targetEl = document.getElementById(targetId);
                    if (targetEl) {
                        targetEl.style.display = 'none';
                    }
                });
            });
        }

        function formatAvahiData(rawLines) {
            if (!rawLines || rawLines.length === 0) {
                return '';
            }
            
            // Remove exact duplicates but keep all unique entries
            const uniqueLines = [];
            const seenLines = new Set();
            
            rawLines.forEach(line => {
                if (!line || !line.includes(';')) {
                    return;
                }
                
                // Normalize line for comparison (trim whitespace)
                const normalized = line.trim();
                if (!seenLines.has(normalized)) {
                    seenLines.add(normalized);
                    uniqueLines.push(line);
                }
            });
            
            // Format all unique entries
            let formatted = '';
            uniqueLines.forEach((line, index) => {
                formatted += formatAvahiLine(line, null, false);
            });
            
            return formatted;
        }

        function formatAvahiLine(line, serviceTypeLabel = null, hasMultiple = false) {
            if (!line || !line.includes(';')) {
                return escapeHtml(line);
            }
            
            const parts = line.split(';');
            if (parts.length < 10) {
                return escapeHtml(line);
            }
            
            const eventType = parts[0];
            const interface = parts[1];
            const protocol = parts[2];
            const name = parts[3];
            const serviceType = parts[4];
            const domain = parts[5];
            const hostname = parts[6];
            const address = parts[7];
            const port = parts[8];
            const txtRecord = parts.slice(9).join(';');
            
            // Decode escaped characters in name
            let decodedName = name
                .replace(/\\064/g, '@')
                .replace(/\\032/g, ' ')
                .replace(/\\040/g, ' ')
                .replace(/\\041/g, '!')
                .replace(/\\126/g, '~');
            
            // Parse TXT record
            const txtFields = {};
            const txtMatches = txtRecord.matchAll(/"([^=]+)=([^"]*)"/g);
            for (const match of txtMatches) {
                txtFields[match[1]] = match[2];
            }
            
            let formatted = '<div class="avahi-entry">';
            formatted += '<div class="avahi-header">';
            formatted += `<span class="avahi-event">${escapeHtml(eventType)}</span> `;
            const displayServiceType = serviceTypeLabel || serviceType;
            formatted += `<span class="avahi-service">${escapeHtml(displayServiceType)}</span>`;
            if (hasMultiple) {
                formatted += ' <span class="avahi-multiple">(multiple entries)</span>';
            }
            formatted += '</div>';
            
            formatted += '<div class="avahi-fields">';
            formatted += '<div class="avahi-field-group">';
            formatted += '<h5>Service Information</h5>';
            formatted += `<div class="avahi-field"><span class="field-label">Name:</span> <span class="field-value">${escapeHtml(decodedName)}</span></div>`;
            formatted += `<div class="avahi-field"><span class="field-label">Type:</span> <span class="field-value">${escapeHtml(serviceType)}</span></div>`;
            formatted += `<div class="avahi-field"><span class="field-label">Domain:</span> <span class="field-value">${escapeHtml(domain)}</span></div>`;
            formatted += '</div>';
            
            formatted += '<div class="avahi-field-group">';
            formatted += '<h5>Network Information</h5>';
            formatted += `<div class="avahi-field"><span class="field-label">Interface:</span> <span class="field-value">${escapeHtml(interface)}</span></div>`;
            formatted += `<div class="avahi-field"><span class="field-label">Protocol:</span> <span class="field-value">${escapeHtml(protocol)}</span></div>`;
            formatted += `<div class="avahi-field"><span class="field-label">Hostname:</span> <span class="field-value">${escapeHtml(hostname)}</span></div>`;
            formatted += `<div class="avahi-field"><span class="field-label">Address:</span> <span class="field-value">${escapeHtml(address)}</span></div>`;
            formatted += `<div class="avahi-field"><span class="field-label">Port:</span> <span class="field-value">${escapeHtml(port)}</span></div>`;
            formatted += '</div>';
            
            if (Object.keys(txtFields).length > 0) {
                formatted += '<div class="avahi-field-group">';
                formatted += '<h5>TXT Record Fields</h5>';
                for (const [key, value] of Object.entries(txtFields)) {
                    formatted += `<div class="avahi-field"><span class="field-label">${escapeHtml(key)}:</span> <span class="field-value">${escapeHtml(value)}</span></div>`;
                }
                formatted += '</div>';
            }
            
            formatted += '</div>';
            formatted += '</div>';
            
            return formatted;
        }

        function renderDeviceRow(device, index) {
            const deviceId = `device-${index}`;
            const hasRawData = device.raw_avahi_data && device.raw_avahi_data.length > 0;
            return `
                <tr class="device-row ${hasRawData ? 'expandable' : ''}" data-device-id="${deviceId}" ${hasRawData ? 'style="cursor: pointer;"' : ''}>
                    <td class="device-name">
                        ${hasRawData ? '<span class="expand-icon">â–¶</span> ' : ''}
                        ${escapeHtml(device.name)}
                    </td>
                    <td class="device-address">${device.address_display ? escapeHtml(device.address_display) : (device.address ? escapeHtml(device.address) : 'â€”')}</td>
                    <td class="device-hostname">${device.hostname ? escapeHtml(device.hostname) : 'â€”'}</td>
                    <td class="device-port">${device.port ? escapeHtml(device.port) : 'â€”'}</td>
                    <td class="device-versions">${device.airplay_versions ? escapeHtml(device.airplay_versions) : 'â€”'}</td>
                    <td class="device-firmware">${device.firmware_version ? escapeHtml(device.firmware_version) : 'â€”'}</td>
                    <td class="device-features">${device.feature_flags ? `<code>${escapeHtml(device.feature_flags)}</code>` : 'â€”'}</td>
                </tr>
                ${hasRawData ? `
                <tr class="device-detail-row" id="${deviceId}-detail" style="display: none;">
                    <td colspan="7" class="device-detail-cell">
                        <div class="device-detail-content">
                            <h4>Raw Avahi Data</h4>
                            <div class="avahi-data-container">
                                ${formatAvahiData(device.raw_avahi_data)}
                            </div>
                            <details class="raw-data-toggle">
                                <summary>Show Raw Text</summary>
                                <pre class="raw-avahi-data">${escapeHtml(device.raw_avahi_data.join('\n'))}</pre>
                            </details>
                        </div>
                    </td>
                </tr>
                ` : ''}
            `;
        }

        // Track expanded rows by device identifier (hostname or name)
        let expandedDevices = new Set();

        function renderDevices(containerId, devices, emptyId) {
            const container = document.getElementById(containerId);
            const empty = document.getElementById(emptyId);
            
            // Save currently expanded devices before clearing (by hostname or name)
            const currentlyExpanded = new Set();
            document.querySelectorAll('.device-row.expanded').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 3) {
                    // Get hostname (3rd cell) or device name (1st cell) as identifier
                    const hostname = cells[2]?.textContent?.trim();
                    const deviceName = cells[0]?.textContent?.replace(/[â–¶â–¼]/g, '').trim();
                    const identifier = (hostname && hostname !== 'â€”') ? hostname : deviceName;
                    if (identifier) {
                        currentlyExpanded.add(identifier);
                    }
                }
            });
            
            container.innerHTML = '';
            container.style.display = 'none';
            empty.style.display = 'none';
            
            if (devices && devices.length > 0) {
                let tableHtml = `
                    <table class="devices-table">
                        <thead>
                            <tr>
                                <th>Device Name</th>
                                <th>IP Address</th>
                                <th>Hostname</th>
                                <th>Port</th>
                                <th>AirPlay Versions</th>
                                <th>Firmware</th>
                                <th>Features</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                devices.forEach((device, index) => {
                    tableHtml += renderDeviceRow(device, index);
                });
                tableHtml += `
                        </tbody>
                    </table>
                `;
                container.innerHTML = tableHtml;
                container.style.display = 'block';
                
                // Attach click handlers for expandable rows and restore expanded state
                document.querySelectorAll('.device-row.expandable').forEach(row => {
                    const deviceId = row.dataset.deviceId;
                    const cells = row.querySelectorAll('td');
                    const hostname = cells[2]?.textContent?.trim();
                    const deviceName = cells[0]?.textContent?.replace(/[â–¶â–¼]/g, '').trim();
                    const identifier = (hostname && hostname !== 'â€”') ? hostname : deviceName;
                    
                    // Check if this device should be expanded
                    const shouldExpand = currentlyExpanded.has(identifier) || expandedDevices.has(identifier);
                    
                    row.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const detailRow = document.getElementById(`${deviceId}-detail`);
                        const expandIcon = this.querySelector('.expand-icon');
                        
                        if (detailRow) {
                            if (detailRow.style.display === 'none') {
                                detailRow.style.display = '';
                                if (expandIcon) expandIcon.textContent = 'â–¼';
                                this.classList.add('expanded');
                                expandedDevices.add(identifier);
                            } else {
                                detailRow.style.display = 'none';
                                if (expandIcon) expandIcon.textContent = 'â–¶';
                                this.classList.remove('expanded');
                                expandedDevices.delete(identifier);
                            }
                        }
                    });
                    
                    // Restore expanded state if it was expanded before
                    if (shouldExpand) {
                        const detailRow = document.getElementById(`${deviceId}-detail`);
                        const expandIcon = row.querySelector('.expand-icon');
                        if (detailRow) {
                            detailRow.style.display = '';
                            if (expandIcon) expandIcon.textContent = 'â–¼';
                            row.classList.add('expanded');
                        }
                    }
                });
            } else {
                empty.style.display = 'block';
            }
        }

        let isRefreshing = false;

        async function refreshBrowser() {
            // Prevent concurrent refreshes
            if (isRefreshing) {
                return;
            }
            
            isRefreshing = true;
            
            // Show loading states
            const devicesLoading = document.getElementById('devices-loading');
            const devicesError = document.getElementById('devices-error');
            const devicesTable = document.getElementById('devices-table');
            const devicesEmpty = document.getElementById('devices-empty');
            
            if (devicesLoading) devicesLoading.style.display = 'block';
            if (devicesError) devicesError.style.display = 'none';
            if (devicesTable) devicesTable.style.display = 'none';
            if (devicesEmpty) devicesEmpty.style.display = 'none';

            // Disable refresh button during load (only if manual refresh)
            const refreshBtn = document.getElementById('refresh-btn');
            const refreshIcon = document.getElementById('refresh-icon');
            const wasDisabled = refreshBtn?.disabled;
            if (refreshBtn && !wasDisabled) {
                refreshBtn.disabled = true;
            }
            if (refreshIcon && !wasDisabled) {
                refreshIcon.style.animation = 'spin 0.5s linear infinite';
            }

            try {
                const response = await fetch('/api/browser', {
                    method: 'GET',
                    cache: 'no-cache',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();

                if (devicesLoading) devicesLoading.style.display = 'none';

                if (data.error) {
                    if (devicesError) {
                        devicesError.textContent = `Error: ${escapeHtml(data.error)}`;
                        devicesError.style.display = 'block';
                    }
                } else {
                    renderDevices('devices-table', data.devices, 'devices-empty');
                }

                // Update timestamp
                if (data.timestamp) {
                    const lastUpdate = document.getElementById('last-update');
                    if (lastUpdate) {
                        const timestamp = new Date(data.timestamp);
                        const timeStr = timestamp.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', second: '2-digit' });
                        lastUpdate.textContent = `Last updated: ${timeStr}`;
                    }
                }

            } catch (error) {
                console.error('Error fetching browser data:', error);
                showError(`Error loading browser data: ${escapeHtml(error.message)}`);
                if (devicesLoading) devicesLoading.style.display = 'none';
            } finally {
                if (refreshBtn && !wasDisabled) {
                    refreshBtn.disabled = false;
                }
                if (refreshIcon && !wasDisabled) {
                    refreshIcon.style.animation = '';
                }
                isRefreshing = false;
            }
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            autoRefreshInterval = setInterval(refreshBrowser, AUTO_REFRESH_INTERVAL);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Initialize
        initMessageClosers();

        // Refresh button handler
        const refreshBtn = document.getElementById('refresh-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                refreshBrowser();
            });
        }

        // Auto-refresh toggle
        const autoRefreshToggle = document.getElementById('auto-refresh-toggle');
        if (autoRefreshToggle) {
            autoRefreshToggle.addEventListener('change', function() {
                if (this.checked) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
        }

        // Initial load
        refreshBrowser();

        // Start auto-refresh if enabled
        if (autoRefreshToggle && autoRefreshToggle.checked) {
            startAutoRefresh();
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });
    </script>
</body>
</html>

