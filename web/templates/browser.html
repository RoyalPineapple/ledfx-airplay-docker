<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirGlow - AirPlay Browser</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="banner-container">
        <img src="https://raw.githubusercontent.com/RoyalPineapple/airglow/master/web/static/banner.jpg" alt="Aurora Borealis" class="banner-image" onerror="this.parentElement.style.display='none'">
        <div class="banner-overlay">
            <h1 class="banner-title">AirGlow</h1>
            <p class="banner-tagline">AirPlay Browser</p>
        </div>
    </div>
    <div class="container">
        <header>
            <nav>
                <a href="/">Home</a>
                <a href="/status">Status Dashboard</a>
                <a href="/config">Configuration</a>
                <a href="http://{{ request.host.split(':')[0] }}:8888" target="_blank">LedFX Web Interface</a>
            </nav>
        </header>

        <div class="status-header">
            <label class="checkbox-label" style="align-items: center; gap: 0.5rem;">
                <input type="checkbox" id="auto-refresh-toggle" class="checkbox-input" checked>
                <span class="checkbox-text">Auto-refresh</span>
            </label>
            <button id="refresh-btn" class="btn btn-primary" title="Refresh browser">
                <span id="refresh-icon">ðŸ”„</span> Refresh
            </button>
            <div id="last-update" class="last-update"></div>
        </div>

        <div id="error-message" class="message error-message" role="alert" style="display: none;">
            <span id="error-text"></span>
            <button type="button" class="message-close" data-target="error-message" aria-label="Dismiss error">&times;</button>
        </div>

        <!-- AirPlay 2 Services Section -->
        <section class="status-section">
            <h2>AirPlay 2 Services (_raop._tcp)</h2>
            <p class="section-description">Discover AirPlay 2 compatible devices on your network</p>
            <div id="airplay2-loading" class="loading" style="display: none;">Loading...</div>
            <div id="airplay2-error" class="error" style="display: none;"></div>
            <div id="airplay2-devices" class="container-cards-grid" style="display: none;"></div>
            <div id="airplay2-empty" class="loading" style="display: none;">No AirPlay 2 devices found on the network.</div>
        </section>

        <!-- AirPlay 1 Services Section -->
        <section class="status-section">
            <h2>AirPlay 1 Services (_airplay._tcp)</h2>
            <p class="section-description">Discover AirPlay 1 compatible devices on your network</p>
            <div id="airplay1-loading" class="loading" style="display: none;">Loading...</div>
            <div id="airplay1-error" class="error" style="display: none;"></div>
            <div id="airplay1-devices" class="container-cards-grid" style="display: none;"></div>
            <div id="airplay1-empty" class="loading" style="display: none;">No AirPlay 1 devices found on the network.</div>
        </section>
    </div>

    <script>
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        let autoRefreshInterval = null;
        const AUTO_REFRESH_INTERVAL = 20000; // 20 seconds

        function showError(message) {
            const errorEl = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            if (errorText) {
                errorText.textContent = message;
            } else {
                errorEl.textContent = message;
            }
            errorEl.style.display = 'flex';
        }

        function initMessageClosers() {
            document.querySelectorAll('.message-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.dataset.target;
                    const targetEl = document.getElementById(targetId);
                    if (targetEl) {
                        targetEl.style.display = 'none';
                    }
                });
            });
        }

        function renderDeviceCard(device) {
            return `
                <div class="container-card">
                    <div class="container-card-header">
                        <h3 class="container-card-title">${escapeHtml(device.name)}</h3>
                    </div>
                    <div class="container-card-body">
                        ${device.address ? `<div class="status-item"><span class="status-label">IP Address:</span> <span class="status-value">${escapeHtml(device.address)}</span></div>` : ''}
                        ${device.hostname ? `<div class="status-item"><span class="status-label">Hostname:</span> <span class="status-value">${escapeHtml(device.hostname)}</span></div>` : ''}
                        ${device.port ? `<div class="status-item"><span class="status-label">Port:</span> <span class="status-value">${escapeHtml(device.port)}</span></div>` : ''}
                        ${device.firmware_version ? `<div class="status-item"><span class="status-label">Firmware:</span> <span class="status-value">${escapeHtml(device.firmware_version)}</span></div>` : ''}
                        ${device.feature_flags ? `<div class="status-item"><span class="status-label">Features:</span> <span class="status-value" style="font-family: monospace; font-size: 0.9rem;">${escapeHtml(device.feature_flags)}</span></div>` : ''}
                    </div>
                </div>
            `;
        }

        function renderDevices(containerId, devices, emptyId) {
            const container = document.getElementById(containerId);
            const empty = document.getElementById(emptyId);
            
            container.innerHTML = '';
            container.style.display = 'none';
            empty.style.display = 'none';
            
            if (devices && devices.length > 0) {
                devices.forEach(device => {
                    container.innerHTML += renderDeviceCard(device);
                });
                container.style.display = 'grid';
            } else {
                empty.style.display = 'block';
            }
        }

        async function refreshBrowser() {
            // Show loading states
            document.getElementById('airplay2-loading').style.display = 'block';
            document.getElementById('airplay2-error').style.display = 'none';
            document.getElementById('airplay2-devices').style.display = 'none';
            document.getElementById('airplay2-empty').style.display = 'none';
            document.getElementById('airplay1-loading').style.display = 'block';
            document.getElementById('airplay1-error').style.display = 'none';
            document.getElementById('airplay1-devices').style.display = 'none';
            document.getElementById('airplay1-empty').style.display = 'none';

            // Disable refresh button during load
            const refreshBtn = document.getElementById('refresh-btn');
            const refreshIcon = document.getElementById('refresh-icon');
            refreshBtn.disabled = true;
            if (refreshIcon) {
                refreshIcon.style.animation = 'spin 0.5s linear infinite';
            }

            try {
                const response = await fetch('/api/browser');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                // Update AirPlay 2 section
                const airplay2Loading = document.getElementById('airplay2-loading');
                const airplay2Error = document.getElementById('airplay2-error');

                airplay2Loading.style.display = 'none';

                if (data.airplay2.error) {
                    airplay2Error.textContent = `Error: ${escapeHtml(data.airplay2.error)}`;
                    airplay2Error.style.display = 'block';
                } else {
                    renderDevices('airplay2-devices', data.airplay2.devices, 'airplay2-empty');
                }

                // Update AirPlay 1 section
                const airplay1Loading = document.getElementById('airplay1-loading');
                const airplay1Error = document.getElementById('airplay1-error');

                airplay1Loading.style.display = 'none';

                if (data.airplay1.error) {
                    airplay1Error.textContent = `Error: ${escapeHtml(data.airplay1.error)}`;
                    airplay1Error.style.display = 'block';
                } else {
                    renderDevices('airplay1-devices', data.airplay1.devices, 'airplay1-empty');
                }

                // Update timestamp
                if (data.timestamp) {
                    const timestamp = new Date(data.timestamp);
                    const timeStr = timestamp.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', second: '2-digit' });
                    document.getElementById('last-update').textContent = `Last updated: ${timeStr}`;
                }

            } catch (error) {
                console.error('Error fetching browser data:', error);
                showError(`Error loading browser data: ${escapeHtml(error.message)}`);
                document.getElementById('airplay2-loading').style.display = 'none';
                document.getElementById('airplay1-loading').style.display = 'none';
            } finally {
                refreshBtn.disabled = false;
                if (refreshIcon) {
                    refreshIcon.style.animation = '';
                }
            }
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            autoRefreshInterval = setInterval(refreshBrowser, AUTO_REFRESH_INTERVAL);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Initialize
        initMessageClosers();

        // Refresh button handler
        const refreshBtn = document.getElementById('refresh-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                refreshBrowser();
            });
        }

        // Auto-refresh toggle
        const autoRefreshToggle = document.getElementById('auto-refresh-toggle');
        if (autoRefreshToggle) {
            autoRefreshToggle.addEventListener('change', function() {
                if (this.checked) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
        }

        // Initial load
        refreshBrowser();

        // Start auto-refresh if enabled
        if (autoRefreshToggle && autoRefreshToggle.checked) {
            startAutoRefresh();
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });
    </script>
</body>
</html>

