# Airglow - AirPlay ➜ LedFX Stack
#
# This stack provides AirPlay 2 audio streaming to LedFX for real-time LED visualization.
# Audio flows: AirPlay Device → Shairport-Sync → PulseAudio → LedFX → LED Devices
#
# Host networking is required for:
# - mDNS/Bonjour discovery (AirPlay device detection)
# - E1.31/UDP LED protocols (direct host network access)
# - Simplified audio routing between containers
#
# Security Note: Host networking gives containers direct network access.
# Only run this on trusted networks.

services:
  ledfx:
    # LedFX - Real-time LED visualization from audio input
    # Web UI: http://localhost:8888
    image: ghcr.io/ledfx/ledfx:latest
    container_name: ledfx

    # Host networking required for E1.31/UDP LED protocols and mDNS
    network_mode: host

    volumes:
      # PulseAudio configuration and socket for inter-container audio
      - ./pulse:/home/ledfx/.config/pulse
      # Persistent LedFX configuration (devices, effects, presets)
      - ledfx-data:/home/ledfx/ledfx-config

    environment:
      # Enable real-time Python output (useful for debugging)
      - PYTHONUNBUFFERED=1

    restart: unless-stopped

    # Ensure shairport-sync starts first
    depends_on:
      - shairport-sync

    # Health check to verify LedFX API is responding
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/api/info"]
      interval: 30s
      timeout: 10s
      retries: 3

    labels:
      # Allow Watchtower to update this container
      - com.centurylinklabs.watchtower.enable=true

  shairport-sync:
    # Shairport-Sync - AirPlay 2 receiver
    # Receives AirPlay audio and outputs to PulseAudio
    image: mikebrady/shairport-sync:latest
    container_name: shairport-sync

    # Host networking required for mDNS/Bonjour AirPlay discovery
    network_mode: host

    environment:
      # Connect to LedFX's PulseAudio server via shared Unix socket
      - PULSE_SERVER=unix:/pulse/pulseaudio.socket
      - PULSE_COOKIE=/pulse/cookie
      # Optional log location for the session hook prototype
      - LEDFX_HOOK_LOG=/var/log/shairport-sync/ledfx-session-hook.log

    volumes:
      # Shairport configuration (AirPlay device name, audio settings)
      - ./configs/shairport-sync.conf:/etc/shairport-sync.conf:ro
      # PulseAudio socket for audio output to LedFX
      - ./pulse:/pulse
      # Prototype session hook scripts triggered on AirPlay start/stop
      - ./scripts:/hooks:ro

    restart: unless-stopped

    labels:
      # Allow Watchtower to update this container
      - com.centurylinklabs.watchtower.enable=true

  watchtower:
    # Automatically pulls newer images and restarts ledfx + shairport-sync
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    command:
      - --cleanup
      - --include-restarting
    environment:
      # Cron schedule: minute hour day-of-month month day-of-week
      # 0 0 * * * = midnight every day (host time)
      - WATCHTOWER_SCHEDULE=0 0 * * *
      # Only update containers that opt-in via label
      - WATCHTOWER_LABEL_ENABLE=true
    volumes:
      # Required for Watchtower to talk to the Docker daemon
      - /var/run/docker.sock:/var/run/docker.sock:ro

volumes:
  # Named volume for LedFX persistent data
  # Contains device configs, effects, presets, and user settings
  ledfx-data:

