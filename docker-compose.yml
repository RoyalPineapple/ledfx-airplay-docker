# Airglow - AirPlay ➜ LedFX Stack
#
# This stack provides AirPlay 2 audio streaming to LedFX for real-time LED visualization.
# Audio flows: AirPlay Device → Shairport-Sync → PulseAudio → LedFX → LED Devices
#
# Network Architecture:
# - airglow-web: Bridge networking (port 8080 exposed)
# - ledfx: Host networking (required for LED device communication across subnets)
# - shairport-sync: Host networking (required for mDNS/Bonjour AirPlay discovery)
#
# Note: Both ledfx and shairport-sync use host networking:
# - shairport-sync: Required for mDNS/Bonjour AirPlay discovery
# - ledfx: Required to communicate with LED devices on different subnets (e.g., 192.168.42.x)
#   Some devices may filter by source IP and only accept connections from specific IPs.

networks:
  airglow-network:
    driver: bridge

services:
  ledfx:
    # LedFX - Real-time LED visualization from audio input
    # Web UI: http://localhost:8888
    image: ghcr.io/ledfx/ledfx:latest
    container_name: ledfx

    # Host networking required for LED device communication across subnets
    # Devices on 192.168.42.x may reject connections from Docker bridge IPs (172.18.x.x)
    network_mode: host

    volumes:
      # PulseAudio configuration and socket for inter-container audio
      - ./pulse:/home/ledfx/.config/pulse
      # Persistent LedFX configuration (devices, effects, presets)
      # Using bind mount to avoid permission issues with named volumes
      - ./ledfx-data:/home/ledfx/ledfx-config

    environment:
      # Enable real-time Python output (useful for debugging)
      - PYTHONUNBUFFERED=1

    restart: unless-stopped

    # Health check to verify LedFX API is responding
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/api/info"]
      interval: 30s
      timeout: 10s
      retries: 3

  shairport-sync:
    # Shairport-Sync - AirPlay 2 receiver
    # Receives AirPlay audio and outputs to PulseAudio
    # Custom image includes jq for JSON parsing in hook scripts
    build:
      context: .
      dockerfile: Dockerfile.shairport-sync
    container_name: shairport-sync

    # Host networking required for mDNS/Bonjour AirPlay discovery
    network_mode: host

    environment:
      # Connect to LedFX's PulseAudio server via shared Unix socket
      - PULSE_SERVER=unix:/pulse/pulseaudio.socket
      - PULSE_COOKIE=/pulse/cookie
      # LedFx API connection for session hooks - use localhost since both are on host networking
      - LEDFX_HOST=localhost
      - LEDFX_PORT=8888
      # Optional log location for the session hook prototype
      - LEDFX_HOOK_LOG=/var/log/shairport-sync/ledfx-session-hook.log

    volumes:
      # Shairport configuration (AirPlay device name, audio settings) - READ ONLY
      - ./configs/shairport-sync.conf:/etc/shairport-sync.conf:ro
      # LedFx hook configuration (YAML format, created dynamically by web app, read by hook scripts)
      - ./configs:/configs:ro
      # PulseAudio socket for audio output to LedFX
      - ./pulse:/pulse
      # Session hook scripts triggered on AirPlay start/stop
      - ./scripts:/scripts:ro

    # Ensure LedFX starts first to create PulseAudio server
    # Note: depends_on doesn't work with network_mode: host, but we keep it for documentation
    depends_on:
      - ledfx

    restart: unless-stopped

  airglow-web:
    # Airglow Status Dashboard - Web interface for status and configuration
    # Web UI: http://localhost:8080
    build:
      context: .
      dockerfile: Dockerfile.web
    container_name: airglow-web

    # Bridge networking - uses container name 'ledfx' for API access
    networks:
      - airglow-network

    ports:
      - "8080:80"

    environment:
      # LedFX API connection - use bridge gateway since ledfx is on host networking
      # Bridge gateway (172.18.0.1) provides access to host networking services
      - LEDFX_HOST=172.18.0.1
      - LEDFX_PORT=8888

    volumes:
      # Configuration files (read-write for config page)
      - ./configs:/configs:rw
      # Diagnostic scripts (read-only)
      - ./scripts:/scripts:ro
      # Docker socket for container status checks
      - /var/run/docker.sock:/var/run/docker.sock:ro

    # Ensure LedFX is available before starting
    depends_on:
      - ledfx

    restart: unless-stopped

    # Health check to verify web interface is responding
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3
