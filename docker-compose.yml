# Airglow - AirPlay ➜ LedFX Stack
#
# This stack provides AirPlay 2 audio streaming to LedFX for real-time LED visualization.
# Audio flows: AirPlay Device → Shairport-Sync → PulseAudio → LedFX → LED Devices
#
# Network Architecture:
# - airglow-web: Bridge networking (port 8080 exposed)
# - ledfx: Bridge networking (ports 8888, 5568, 6454, 21324, 4048, 8889, 4002, 4003 exposed)
#   Note: Philips Hue uses outbound HTTP/HTTPS (80/443) - no ports exposed
# - avahi: Host networking (handles mDNS/Bonjour on physical network with reflector enabled)
# - nqptp: Host networking (provides AirPlay 2 timing synchronization, ports 319, 320)
# - shairport-sync: Bridge networking (connects to Avahi via D-Bus, ports 7000, 5000, 319, 320 exposed)
#
# Note: All services now use bridge networking except Avahi and NQPTP, which require host networking
# for mDNS/Bonjour discovery and PTP timing on the physical network. Avahi reflector is enabled
# to forward mDNS traffic between network interfaces. NQPTP and shairport-sync communicate via
# shared memory (/dev/shm) for AirPlay 2 timing synchronization.

networks:
  airglow-network:
    driver: bridge

services:
  avahi:
    # Avahi - mDNS/Bonjour service for AirPlay discovery
    # Runs on host networking to access physical network for mDNS
    # Reflector mode enabled to forward mDNS traffic between interfaces
    build:
      context: .
      dockerfile: Dockerfile.avahi
    container_name: avahi
    network_mode: host
    
    volumes:
      # Avahi configuration with reflector enabled
      - ./configs/avahi-daemon.conf:/etc/avahi/avahi-daemon.conf:ro
      # D-Bus socket for shairport-sync to connect
      - /var/run/dbus:/var/run/dbus:rw
    
    restart: unless-stopped

  nqptp:
    # NQPTP - Network Quality Precision Time Protocol for AirPlay 2
    # Provides timing synchronization required for AirPlay 2
    # Communicates with shairport-sync via shared memory
    build:
      context: .
      dockerfile: Dockerfile.nqptp
    container_name: nqptp
    network_mode: host
    
    # Share /dev/shm with shairport-sync for shared memory communication
    volumes:
      - /dev/shm:/dev/shm:rw
    
    restart: unless-stopped

  ledfx:
    # LedFX - Real-time LED visualization from audio input
    # Web UI: http://localhost:8888
    image: ghcr.io/ledfx/ledfx:latest
    container_name: ledfx

    # Bridge networking - port mappings for web UI and LED protocols
    networks:
      - airglow-network

    ports:
      - "8888:8888"      # Web UI and API (HTTP)
      - "5568:5568/udp"  # E1.31/sACN protocol (multicast)
      - "6454:6454/udp"  # ArtNet protocol (DMX over Ethernet)
      - "21324:21324/udp" # WLED UDP protocol (unicast)
      - "4048:4048/udp"  # DDP protocol (unicast)
      - "8889:8889/udp"  # WLED device discovery (optional but recommended)
      - "4002:4002/udp"  # Govee device responses (receive port)
      - "4003:4003/udp"  # Govee device control (send commands to device)
      # Note: Philips Hue uses outbound HTTP/HTTPS (ports 80/443) to Hue Bridge
      # No ports need to be exposed - LEDFX makes outbound connections to the bridge
      # Note: LIFX uses outbound UDP (port 56700) for device communication
      # No ports need to be exposed - LEDFX sends commands and receives responses automatically
      # Note: Nanoleaf uses outbound HTTP (port 16021) and UDP (port 60222/60221) for device communication
      # No ports need to be exposed - LEDFX makes outbound connections to the device
      # Note: OpenPixelControl uses outbound UDP (port 7890) for device communication
      # No ports need to be exposed - LEDFX sends pixel data to OPC devices
      # Note: OpenRGB uses outbound TCP (port 6742 default) to OpenRGB SDK server
      # No ports need to be exposed - LEDFX connects to OpenRGB server on host/network
      # Note: OSC (Open Sound Control) uses outbound UDP (port 9000 default, configurable)
      # No ports need to be exposed - LEDFX sends OSC messages to OSC servers
      # Note: Novation Launchpad uses USB MIDI (via rtmidi library)
      # No network ports needed - requires USB device passthrough if used
      # Note: RPi WS281X uses Raspberry Pi GPIO pins (local hardware interface)
      # No network ports needed - requires GPIO access and /dev/mem if used in Docker
      # Note: Twinkly Squares uses outbound HTTP/HTTPS and UDP (port 7777) for real-time frames
      # No ports need to be exposed - LEDFX connects to Twinkly devices
      # Note: Zengge/MagicHome/FluxLED uses outbound UDP (port 5577) for device control
      # No ports need to be exposed - LEDFX sends commands to FluxLED devices
      # Note: UDP Realtime Device uses configurable UDP ports (default 21324, same as WLED UDP)
      # No additional ports needed - uses same ports as WLED UDP protocol

    volumes:
      # PulseAudio configuration and socket for inter-container audio
      - ./pulse:/home/ledfx/.config/pulse
      # Persistent LedFX configuration (devices, effects, presets)
      # Using bind mount to avoid permission issues with named volumes
      - ./ledfx-data:/home/ledfx/ledfx-config

    environment:
      # Enable real-time Python output (useful for debugging)
      - PYTHONUNBUFFERED=1

    restart: unless-stopped

    # Health check to verify LedFX API is responding
    # Use 127.0.0.1 instead of localhost for bridge networking
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8888/api/info"]
      interval: 30s
      timeout: 10s
      retries: 3

  shairport-sync:
    # Shairport-Sync - AirPlay 2 receiver
    # Receives AirPlay audio and outputs to PulseAudio
    # Custom image includes jq for JSON parsing in hook scripts
    # Now on bridge networking, connects to Avahi via D-Bus for mDNS
    build:
      context: .
      dockerfile: Dockerfile.shairport-sync
    container_name: shairport-sync
    
    # Override entrypoint to use our custom startup script that connects to Avahi
    entrypoint: ["/bin/sh", "-c", "while [ ! -S /var/run/dbus/system_bus_socket ]; do echo 'Waiting for D-Bus socket from Avahi...'; sleep 1; done; exec shairport-sync"]

    # Bridge networking - connect to Avahi via D-Bus
    networks:
      - airglow-network

    ports:
      - "7000:7000"      # AirPlay control (TCP)
      - "5000:5000"      # AirPlay audio (TCP)
      - "5000:5000/udp"  # AirPlay audio (UDP)
      # Note: NQPTP ports (319, 320/UDP) are handled by the nqptp container on host networking

    environment:
      # Connect to LedFX's PulseAudio server via shared Unix socket
      - PULSE_SERVER=unix:/pulse/pulseaudio.socket
      - PULSE_COOKIE=/pulse/cookie
      # LedFX API connection - use container name for service discovery
      - LEDFX_HOST=ledfx
      - LEDFX_PORT=8888
      # Optional log location for the session hook prototype
      - LEDFX_HOOK_LOG=/var/log/shairport-sync/ledfx-session-hook.log
      # D-Bus connection to Avahi container
      - DBUS_SYSTEM_BUS_ADDRESS=unix:path=/var/run/dbus/system_bus_socket

    volumes:
      # Shairport configuration (AirPlay device name, audio settings)
      # Mounted as read-write so startup script can dynamically set host IP
      - ./configs/shairport-sync.conf:/etc/shairport-sync.conf:rw
      # LedFX hook configuration (YAML format, created dynamically by web app, read by hook scripts)
      - ./configs:/configs:ro
      # PulseAudio socket for audio output to LedFX
      - ./pulse:/pulse
      # Session hook scripts triggered on AirPlay start/stop
      - ./scripts:/scripts:ro
      # D-Bus socket to connect to Avahi container
      - /var/run/dbus:/var/run/dbus:ro
      # Shared memory for NQPTP to communicate with shairport-sync
      - /dev/shm:/dev/shm

    # Ensure Avahi, NQPTP, and LedFX start first
    depends_on:
      - avahi
      - nqptp
      - ledfx

    restart: unless-stopped

  airglow-web:
    # Airglow Status Dashboard - Web interface for status and configuration
    # Web UI: http://localhost:8080
    build:
      context: .
      dockerfile: Dockerfile.web
    container_name: airglow-web

    # Bridge networking - uses container name 'ledfx' for API access
    networks:
      - airglow-network

    ports:
      - "8080:80"

    environment:
      # LedFX API connection - use container name for service discovery
      - LEDFX_HOST=ledfx
      - LEDFX_PORT=8888

    volumes:
      # Configuration files (read-write for config page)
      - ./configs:/configs:rw
      # Diagnostic scripts (read-only)
      - ./scripts:/scripts:ro
      # Docker socket for container status checks
      - /var/run/docker.sock:/var/run/docker.sock:ro

    # Ensure LedFX is available before starting
    depends_on:
      - ledfx

    restart: unless-stopped

    # Health check to verify web interface is responding
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3
